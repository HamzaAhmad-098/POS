<!-- app/views/sales/receipt.html.erb -->
<div class="container receipt-container">
  <div class="receipt">
    <div class="receipt-header">
      <h2><%= Current.shop.name %></h2>
      <p><%= Current.shop.address %></p>
      <p>Phone: <%= Current.shop.phone %></p>
    </div>

    <div class="receipt-info">
      <p><strong>Invoice #:</strong> <%= @sale.invoice_no %></p>
      <p><strong>Date:</strong> <%= @sale.created_at.localtime.strftime("%d/%m/%Y %I:%M %p") %></p>
      <p><strong>Cashier:</strong> <%= @sale.user.full_name %></p>
      <% if @sale.customer %>
        <p><strong>Customer:</strong> <%= @sale.customer.name %></p>
      <% end %>
    </div>

    <div class="receipt-items">
      <table class="table table-sm">
        <thead>
          <tr>
            <th>Item</th>
            <th>Qty</th>
            <th>Price</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <% @sale.sale_items.each do |item| %>
            <tr>
              <td><%= item.product.name %></td>
              <td><%= item.qty %></td>
              <td>Rs. <%= item.unit_price %></td>
              <td>Rs. <%= item.total_price %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <div class="receipt-totals">
      <div class="total-row">
        <span>Subtotal:</span>
        <span>Rs. <%= @sale.subtotal_amount %></span>
      </div>
      <% if @sale.discount_cents > 0 %>
        <div class="total-row">
          <span>Discount:</span>
          <span>-Rs. <%= @sale.discount_amount %></span>
        </div>
      <% end %>
      <% if @sale.tax_cents > 0 %>
        <div class="total-row">
          <span>Tax:</span>
          <span>Rs. <%= @sale.tax_amount %></span>
        </div>
      <% end %>
      <div class="total-row grand-total">
        <span><strong>Total:</strong></span>
        <span><strong>Rs. <%= @sale.total_amount %></strong></span>
      </div>
    </div>

    <div class="receipt-footer">
      <p><strong>Payment Method:</strong> <%= @sale.payment_method.to_s.humanize %></p>
      <p class="thank-you">Thank you for your Shopping!</p>
    </div>
  </div>

  <div class="receipt-actions mt-4">
    <%= link_to "üñ®Ô∏è Print Receipt", "javascript:window.print()", class: "btn btn-primary" %>
    <%= link_to "üõí New Sale", new_sale_path, class: "btn btn-success" %>
    <%= link_to "üìä View All Sales", sales_path, class: "btn btn-outline" %>
  </div>

  <!-- WhatsApp Share Section -->
  <div class="whatsapp-section mt-4">
    <div class="whatsapp-box">
      <h4>üì± Send Receipt via WhatsApp</h4>
      <p class="whatsapp-hint">Enter customer's WhatsApp number to send this receipt</p>
      
      <div class="whatsapp-form">
        <div class="input-group">
          <input 
            type="tel" 
            id="whatsappNumber" 
            class="form-control" 
            placeholder="e.g., 03001234567" 
            pattern="[0-9]{11}"
            maxlength="11"
          >
          <button class="btn btn-whatsapp" onclick="sendWhatsAppReceipt()">
            üì§ Send
          </button>
        </div>
        <small class="form-text text-muted">
          Enter 11-digit Pakistani number without country code (e.g., 03001234567)
        </small>
      </div>

      <div id="whatsappStatus" class="whatsapp-status" style="display: none;"></div>
    </div>
  </div>
</div>


<!-- üî• FIX: Make Rails data available to JavaScript -->
<script>
const receiptData = <%= {
  shop_name: Current.shop.name,
  shop_address: Current.shop.address,
  shop_phone: Current.shop.phone,
  invoice_no: @sale.invoice_no,
  date: @sale.created_at.localtime.strftime("%d/%m/%Y %I:%M %p"),
  cashier: @sale.user.full_name,
  customer: (@sale.customer&.name || ""),
  items: @sale.sale_items.map { |i|
    { name: i.product.name, qty: i.qty, unit_price: i.unit_price, total_price: i.total_price }
  },
  subtotal: @sale.subtotal_amount,
  discount: @sale.discount_amount,
  has_discount: @sale.discount_cents > 0,
  tax: @sale.tax_amount,
  has_tax: @sale.tax_cents > 0,
  total: @sale.total_amount,
  payment_method: @sale.payment_method.to_s.humanize
}.to_json.html_safe %>;
</script>



<style>
.receipt-container {
  max-width: 400px;
  margin: 0 auto;
}

.receipt {
  background: white;
  padding: 20px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-family: 'Courier New', monospace;
}

.receipt-header {
  text-align: center;
  border-bottom: 2px dashed #ddd;
  padding-bottom: 15px;
  margin-bottom: 15px;
}

.receipt-header h2 {
  margin: 0;
  font-size: 1.5em;
}

.receipt-info {
  margin-bottom: 15px;
}

.receipt-items table {
  width: 100%;
  margin-bottom: 15px;
}

.receipt-items th {
  border-bottom: 1px solid #ddd;
  padding: 5px 0;
}

.receipt-items td {
  padding: 3px 0;
  border-bottom: 1px dashed #eee;
}

.receipt-totals {
  border-top: 2px dashed #ddd;
  padding-top: 10px;
}

.total-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 5px;
}

.total-row.grand-total {
  border-top: 1px solid #000;
  padding-top: 5px;
  font-size: 1.1em;
}

.receipt-footer {
  text-align: center;
  border-top: 2px dashed #ddd;
  padding-top: 15px;
  margin-top: 15px;
}

.thank-you {
  font-style: italic;
  margin-top: 10px;
}

/* WhatsApp Section Styles */
.whatsapp-box {
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 8px;
  padding: 20px;
  text-align: center;
}

.whatsapp-box h4 {
  color: #25D366;
  margin-bottom: 8px;
}

.whatsapp-hint {
  color: #6c757d;
  margin-bottom: 15px;
  font-size: 14px;
}

.whatsapp-form .input-group {
  display: flex;
  gap: 10px;
  margin-bottom: 8px;
}

.whatsapp-form .form-control {
  flex: 1;
  padding: 12px;
  border: 2px solid #ddd;
  border-radius: 6px;
  font-size: 16px;
}

.btn-whatsapp {
  background: #25D366;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 12px 20px;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.3s;
}

.btn-whatsapp:hover {
  background: #128C7E;
}

.whatsapp-status {
  margin-top: 10px;
  padding: 10px;
  border-radius: 6px;
  font-weight: bold;
}

.whatsapp-status.success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.whatsapp-status.error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

@media print {
  .receipt-actions,
  .whatsapp-section {
    display: none;
  }
  
  .receipt {
    border: none;
    box-shadow: none;
  }
}
</style>



<!-- ------------------ JAVASCRIPT ---------------------- -->

<script>
function sendWhatsAppReceipt() {
  const phoneInput = document.getElementById('whatsappNumber');
  const statusDiv = document.getElementById('whatsappStatus');
  const phoneNumber = phoneInput.value.trim();

  // Validate phone number (Pakistani)
  const phoneRegex = /^[0-9]{11}$/;
  if (!phoneRegex.test(phoneNumber)) {
    statusDiv.textContent = '‚ùå Please enter a valid 11-digit phone number';
    statusDiv.className = 'whatsapp-status error';
    statusDiv.style.display = 'block';
    return;
  }

  // Convert 0300xxxxxxx ‚Üí 92300xxxxxxx
  const formattedNumber = '92' + phoneNumber.substring(1);

  // Create WhatsApp message
  const receiptMessage = createReceiptMessage();

  // Encode for URL
  const encodedMessage = encodeURIComponent(receiptMessage);

  // Open WhatsApp
  const whatsappUrl = `https://wa.me/${formattedNumber}?text=${encodedMessage}`;
  window.open(whatsappUrl, '_blank');

  // Success message
  statusDiv.textContent = '‚úÖ WhatsApp opened with receipt. Click send.';
  statusDiv.className = 'whatsapp-status success';
  statusDiv.style.display = 'block';

  phoneInput.value = '';

  setTimeout(() => {
    statusDiv.style.display = 'none';
  }, 5000);
}



function createReceiptMessage() {
  return `
*${receiptData.shop_name}*
${receiptData.shop_address}
Phone: ${receiptData.shop_phone}

*INVOICE RECEIPT*

Invoice #: ${receiptData.invoice_no}
Date: ${receiptData.date}
Cashier: ${receiptData.cashier}
${receiptData.customer ? `Customer: ${receiptData.customer}` : ''}

*ITEMS*
${receiptData.items.map(item =>
  `${item.name} - ${item.qty} x Rs. ${item.unit_price} = Rs. ${item.total_price}`
).join('\n')}

*TOTALS*
Subtotal: Rs. ${receiptData.subtotal}
${receiptData.has_discount ? `Discount: -Rs. ${receiptData.discount}\n` : ''}
${receiptData.has_tax ? `Tax: Rs. ${receiptData.tax}\n` : ''}
*GRAND TOTAL: Rs. ${receiptData.total}*

Payment Method: ${receiptData.payment_method}

Thank you for your shopping! üõçÔ∏è
`.trim();
}



// Enter key support
document.getElementById('whatsappNumber').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    sendWhatsAppReceipt();
  }
});
</script>
